<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#B49594">
  <title>Marine & Alexis</title>
  <style>
    :root{
      --c1:#D5DFE5; --c2:#C9B1BD; --c3:#B49594; --c4:#7F9172; --c5:#567568;
      --bg: var(--c2);
      --card:#f7f8fa;
      --text:#1b1f23; --muted:#5b6872;
      --shadow: 0 10px 28px rgba(0,0,0,.14);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
    .app{min-height:100svh;display:flex;flex-direction:column;align-items:stretch;justify-content:stretch;
      padding:max(12px,env(safe-area-inset-top)) max(12px,env(safe-area-inset-right)) max(16px,env(safe-area-inset-bottom)) max(12px,env(safe-area-inset-left));}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06);}
    .btn{appearance:none;border:0;border-radius:14px;padding:14px 18px;font-weight:700;background:var(--c5);color:white;box-shadow:var(--shadow);
      cursor:pointer;transition:transform .06s ease,opacity .2s ease,background .2s ease;}
    .btn:active{transform:translateY(1px);} .btn.secondary{background:var(--c3);} .btn.ghost{background:transparent;color:var(--c5);border:1px solid var(--c5);} .btn.warn{background:#9b2c2c;}
    .hidden{display:none !important;}
    header.topbar{display:flex;align-items:center;gap:10px;padding:10px;position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(185,149,148,.92),rgba(185,149,148,.65));
      backdrop-filter:blur(8px);border-radius:14px;border:1px solid rgba(0,0,0,.08);}
    .iconbtn{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;background:white;border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow);cursor:pointer;}
    .grow{flex:1}.title{font-weight:800;letter-spacing:.2px;}.subtitle{color:var(--muted);font-size:13px;}
    .welcome{margin-top:10vh;padding:22px;text-align:center;}
    .welcome h1{font-size:28px;margin:0 0 6px 0;} .welcome p{color:var(--muted);margin:0 0 18px 0;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .pill{padding:10px 14px;border-radius:999px;background:rgba(86,117,104,.18);color:#1f2b24;font-size:12px;display:inline-flex;align-items:center;gap:8px;}
    .tiny{margin-top:14px;font-size:12px;color:#344E41;opacity:.8;}
    .tiny a{color:#344E41;text-decoration:underline;cursor:pointer;}
    .content{padding:14px;} .module{padding:16px;}
    nav.drawer{position:fixed;inset:0;z-index:50;pointer-events:none;} nav.drawer .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.32);opacity:0;transition:opacity .2s ease;}
    nav.drawer .panel{position:absolute;top:0;bottom:0;right:0;width:78vw;max-width:360px;background:var(--card);border-left:1px solid rgba(0,0,0,.08);box-shadow:var(--shadow);
      transform:translateX(100%);transition:transform .22s ease;display:flex;flex-direction:column;padding:14px;border-top-left-radius:16px;border-bottom-left-radius:16px;}
    nav.drawer.open{pointer-events:auto;} nav.drawer.open .backdrop{opacity:1;} nav.drawer.open .panel{transform:translateX(0);}
    .navitem{padding:12px 14px;border-radius:12px;display:flex;align-items:center;gap:12px;font-weight:600;} .navitem:hover{background:#eef1f4;cursor:pointer;}
    .footerNote{margin-top:auto;font-size:12px;color:var(--muted);} .chip{display:inline-flex;gap:6px;align-items:center;padding:8px 12px;border-radius:999px;background:#eef1f4;font-size:12px;}
    .sectionTitle{font-weight:800;margin:0 0 8px 0;} .muted{color:var(--muted);}
    .toast{position:fixed;right:16px;bottom:16px;background:#111;color:white;padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:.25s ease;z-index:60;max-width:90vw;}
    .toast.show{opacity:1;transform:translateY(0);}
    .modal{position:fixed;inset:0;z-index:70;display:none;align-items:center;justify-content:center;}
    .modal.open{display:flex !important;} .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35);}
    .modal .dialog{position:relative;background:var(--card);border-radius:16px;box-shadow:var(--shadow);width:min(92vw,560px);padding:16px;border:1px solid rgba(0,0,0,.08);}
    .modal .close{position:absolute;right:10px;top:10px;width:36px;height:36px;border-radius:10px;display:grid;place-items:center;border:1px solid rgba(0,0,0,.1);background:#fff;cursor:pointer;}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0;} .field label{font-size:13px;color:var(--muted);}
    .field input,.field select,.field textarea{padding:12px;border-radius:12px;border:1px solid #e5e7eb;outline:none;background:white;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .giftRow{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:10px;border-radius:12px;border:1px solid #e4e7ea;margin-bottom:8px;background:#fff;}
    .giftRow a{font-weight:700;text-decoration:none;color:#2b3a2f;} .giftRow .price{font-variant-numeric:tabular-nums;font-weight:700;color:#2b3a2f;background:rgba(86,117,104,.18);padding:6px 10px;border-radius:999px;}
    .pot{display:flex;flex-direction:column;gap:4px;margin:6px 0 14px 0;} .pot .big{font-size:32px;font-weight:900;letter-spacing:.2px;}
    .gridCards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;} .cardBtn{padding:14px;border-radius:14px;border:1px solid #e6e8eb;display:grid;place-items:center;font-weight:800;cursor:pointer;box-shadow:var(--shadow);background:#fff;}
    .month{border:1px solid #e4e7ea;border-radius:14px;margin:10px 0;overflow:hidden;background:#fff;} .monthHead{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#f2f4f6;cursor:pointer;}
    .monthHead .total{font-weight:800;background:rgba(86,117,104,.18);padding:6px 10px;border-radius:999px;} .monthBody{padding:8px 10px;display:none;} .month.open .monthBody{display:block;}
    .expRow{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border-radius:12px;border:1px solid #eef1f3;margin:6px 0;background:#fff;}
    .badge{padding:6px 10px;border-radius:999px;background:#eef1f3;font-weight:700;font-size:12px;}
    .miniCards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0 12px 0;}
    .miniCard{padding:12px;border:1px solid #e6e8eb;background:#fff;border-radius:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:4px;}
    .miniCard .label{font-size:12px;color:var(--muted);} .miniCard .value{font-size:20px;font-weight:900;}
    .annivWrap{display:grid;gap:10px;}
    .annivBox{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border:1px solid #e4e7ea;border-radius:14px;background:#fff;}
    .annivBox .big{font-size:20px;font-weight:900;} .annivBox .days{font-variant-numeric:tabular-nums;font-weight:900;}
    .noteBox{width:100%;min-height:160px;resize:vertical;background:#fff;}
    .toolbar{display:flex;align-items:center;gap:8px;margin:6px 0 10px 0;}
    .toolbar select{padding:8px 10px;border-radius:10px;border:1px solid #e4e7eb;background:white;}
  </style>
</head>
<body>
  <div class="app">
    <!-- Welcome -->
    <section id="screen-welcome" class="card welcome">
      <div class="pill">Projet commun ¬∑ Marine & Alexis</div>
      <h1>On commence üíö</h1>
      <p>Choisis ton profil. Connexion l√©g√®re (pas d‚Äôauth), donn√©es Firestore.</p>
      <div class="grid2">
        <button class="btn" data-user="marine" onclick="return window.connectAs ? (window.connectAs('marine'), false) : true;">Marine</button>
        <button class="btn secondary" data-user="alexis" onclick="return window.connectAs ? (window.connectAs('alexis'), false) : true;">Alexis</button>
      </div>
      <div class="tiny">‚ö†Ô∏è <a id="linkNuke" onclick="return window.showNuke ? (window.showNuke(), false) : true;">supprimer les d√©penses et les comptes</a></div>
      <p style="margin-top:14px" class="subtitle">iPhone 15 & Redmi Note 13 Pro ¬∑ Portrait</p>
    </section>

    <!-- Main -->
    <section id="screen-main" class="hidden">
      <header class="topbar">
        <button id="btnBack" class="iconbtn" title="Retour">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="#567568" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div class="grow"><div class="title" id="titleUser">Bonjour</div><div class="subtitle" id="subtitle">Menu principal</div></div>
        <button id="btnMenu" class="iconbtn" title="Menu"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="#7F9172" stroke-width="2" stroke-linecap="round"/></svg></button>
      </header>

      <div class="content">
        <div id="home" class="card module">
          <h3 class="sectionTitle">Bienvenue <span id="helloName"></span> !</h3>
          <p class="muted">Menu (‚ò∞) : <b>Cadeau</b>, <b>Compte commun</b>, <b>D√©penses</b>, <b>Anniversaires</b>, <b>Notes</b>, <b>Mot du jour</b>, <b>√âpingl√©s</b>.</p>
          <div style="height:8px"></div><div class="chip">v2.3 ‚Äî Rebuild clean + tri cadeaux</div>
        </div>

        <!-- Cadeaux -->
        <div id="cadeau" class="card module hidden">
          <div class="row" style="justify-content:space-between;"><h3 class="sectionTitle">Cadeaux</h3><div class="chip" id="whoseListLabel"></div></div>
          <p class="muted">Ajoute, supprime, ou consulte la liste de l‚Äôautre.</p>
          <div class="row" style="margin:10px 0 14px 0;">
            <button id="btnAddGift" class="btn">Ajouter √† ma liste</button>
            <button id="btnDeleteGift" class="btn warn">Supprimer dans ma liste</button>
            <button id="btnViewOther" class="btn ghost"></button>
          </div>
          <div id="otherListWrap" class="hidden">
            <div class="toolbar">
              <label class="muted" for="otherSort">Trier :</label>
              <select id="otherSort">
                <option value="date_desc">Date d‚Äôajout (r√©cent ‚Üí ancien)</option>
                <option value="price_asc">Prix (croissant)</option>
                <option value="price_desc">Prix (d√©croissant)</option>
              </select>
            </div>
            <h4 style="margin:8px 0 12px 0">Liste de <span id="otherName"></span></h4>
            <div id="otherList"></div>
          </div>
        </div>

        <!-- Cagnotte -->
        <div id="cagnotte" class="card module hidden">
          <div class="row" style="justify-content:space-between;"><h3 class="sectionTitle">Compte commun</h3><div class="chip">Partag√©</div></div>
          <div class="pot"><div class="muted">Montant actuel</div><div id="potAmount" class="big">‚Äî</div></div>
          <div class="gridCards">
            <button class="cardBtn" data-add="5">+5‚Ç¨</button><button class="cardBtn" data-add="10">+10‚Ç¨</button><button class="cardBtn" data-add="15">+15‚Ç¨</button>
            <button class="cardBtn" data-add="20">+20‚Ç¨</button><button class="cardBtn" data-add="30">+30‚Ç¨</button><button class="cardBtn" data-add="50">+50‚Ç¨</button>
            <button class="cardBtn" data-add="100">+100‚Ç¨</button><button class="cardBtn" data-add="150">+150‚Ç¨</button><button class="cardBtn" data-add="200">+200‚Ç¨</button>
            <button id="btnCustomAdd" class="cardBtn">Choisir</button>
          </div>
        </div>

        <!-- D√©penses -->
        <div id="depenses" class="card module hidden">
          <div class="row" style="justify-content:space-between;"><h3 class="sectionTitle">D√©penses</h3><button id="btnAddExp" class="btn">Ajouter une d√©pense</button></div>
          <div class="miniCards">
            <div class="miniCard"><div class="label">Total Marine</div><div id="totalMarine" class="value">‚Äî</div></div>
            <div class="miniCard"><div class="label">Total Alexis</div><div id="totalAlexis" class="value">‚Äî</div></div>
          </div>
          <p class="muted">Tap sur un mois pour d√©rouler. Les d√©penses du <b>compte commun</b> sont automatiquement d√©duites de la cagnotte (sans passer sous 0). Si insuffisant, on choisit qui paie le reste.</p>
          <div id="monthsWrap"></div>
        </div>

        <!-- Anniversaires -->
        <div id="anniv" class="card module hidden">
          <div class="row" style="justify-content:space-between;"><h3 class="sectionTitle">Anniversaires</h3></div>
          <div class="annivWrap">
            <div class="annivBox">
              <div><div class="muted">Anniversaire de couple</div><div class="big"><span id="coupleYears">1 an</span></div></div>
              <div class="days" id="coupleDays">‚Äî jours</div>
            </div>
            <div class="annivBox">
              <div><div class="muted">Anniv Alexis (22 f√©vrier)</div><div class="big">Prochain</div></div>
              <div class="days" id="alexisDays">‚Äî jours</div>
            </div>
            <div class="annivBox">
              <div><div class="muted">Anniv Marine (31 mai)</div><div class="big">Prochain</div></div>
              <div class="days" id="marineDays">‚Äî jours</div>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div id="notes" class="card module hidden">
          <div class="row" style="justify-content:space-between;"><h3 class="sectionTitle">Notes</h3><div class="chip">Auto-enregistrement</div></div>
          <div class="field"><label for="noteBox">Tes notes</label><textarea id="noteBox" class="noteBox" placeholder="√âcris ici‚Ä¶"></textarea></div>
          <div class="muted" id="noteStatus">‚Äî</div>
        </div>

        <!-- Mot du jour -->
        <div id="mots" class="card module hidden">
          <div class="row" style="justify-content:space-between;">
            <h3 class="sectionTitle">Mot du jour</h3>
            <div class="chip">Livraison J+7</div>
          </div>
          <p class="muted">√âcris un petit mot (max 200 caract√®res) pour l‚Äôautre. Il arrivera dans sa bo√Æte 7 jours plus tard.</p>
          <div class="row" style="margin:10px 0 14px 0;">
            <button id="btnOpenInbox" class="btn">Ouvrir les mots de ‚Ä¶</button>
            <button id="btnCompose" class="btn secondary">√âcrire ma note du jour</button>
          </div>
          <div id="inboxWrap" class="hidden">
            <h4 style="margin:8px 0 12px 0">Bo√Æte de r√©ception de <span id="inboxOwner"></span></h4>
            <div id="inboxList"></div>
          </div>
        </div>

        <!-- √âpingl√©s -->
        <div id="epingles" class="card module hidden">
          <div class="row" style="justify-content:space-between;">
            <h3 class="sectionTitle">√âpingl√©s</h3>
            <div class="chip">Favoris</div>
          </div>
          <div id="pinsList"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Drawer -->
  <nav id="drawer" class="drawer">
    <div class="backdrop" id="drawerBackdrop"></div>
    <aside class="panel">
      <h3 style="margin:6px 4px 10px 4px">Cat√©gories</h3>
      <button class="navitem" data-nav="cadeau">üéÅ Cadeau</button>
      <button class="navitem" data-nav="cagnotte">üí∂ Compte commun</button>
      <button class="navitem" data-nav="depenses">üßæ D√©penses</button>
      <button class="navitem" data-nav="anniversaires">üéÇ Anniversaires</button>
      <button class="navitem" data-nav="notes">üìù Notes</button>
      <button class="navitem" data-nav="mots">üíå Mot du jour</button>
      <button class="navitem" data-nav="epingles">üìå √âpingl√©s</button>
      <div class="footerNote">v2.3 ‚Äî Clean + tri cadeaux</div>
    </aside>
  </nav>

  <!-- Modals -->
  <div id="modalGift" class="modal" aria-hidden="true"><div class="backdrop"></div><div class="dialog">
    <button class="close" id="closeGift" title="Fermer"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#7F7F7F" stroke-width="2" stroke-linecap="round"/></svg></button>
    <h3 style="margin:0 0 8px 0">Ajouter un √©l√©ment √† ma liste</h3>
    <div class="field"><label for="giftName">Nom de l‚Äôarticle</label><input id="giftName" type="text" placeholder="Ex. Parfum, livre‚Ä¶"></div>
    <div class="field"><label for="giftPrice">Prix (‚Ç¨)</label><input id="giftPrice" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="Ex. 29.90"></div>
    <div class="field"><label for="giftUrl">Lien (optionnel)</label><input id="giftUrl" type="url" placeholder="https://..."></div>
    <div class="row" style="justify-content:flex-end;margin-top:12px;"><button id="cancelGift" class="btn ghost">Annuler</button><button id="saveGift" class="btn">Ajouter √† ma liste</button></div>
  </div></div>

  <div id="modalDelGift" class="modal" aria-hidden="true"><div class="backdrop"></div><div class="dialog">
    <button class="close" id="closeDelGift" title="Fermer"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#7F7F7F" stroke-width="2" stroke-linecap="round"/></svg></button>
    <h3 style="margin:0 0 8px 0">Supprimer des objets de ma liste</h3>
    <p class="muted" style="margin:0 0 12px 0">Coche un ou plusieurs √©l√©ments puis clique sur <b>Supprimer</b>.</p>
    <div id="delGiftList" style="max-height:45vh;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:8px;"></div>
    <div class="row" style="justify-content:flex-end;margin-top:12px;"><button id="cancelDelGift" class="btn ghost">Annuler</button><button id="confirmDelGift" class="btn warn">Supprimer</button></div>
  </div></div>

  <div id="modalCustom" class="modal" aria-hidden="true"><div class="backdrop"></div><div class="dialog">
    <button class="close" id="closeCustom" title="Fermer"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#7F7F7F" stroke-width="2" stroke-linecap="round"/></svg></button>
    <h3 style="margin:0 0 8px 0">Choisir un montant</h3><p class="muted" style="margin:0 0 12px 0">Montant en euros (chiffres uniquement).</p>
    <div class="field"><label for="customAmount">Montant (‚Ç¨)</label><input id="customAmount" inputmode="numeric" pattern="[0-9]*" placeholder="Ex. 42"></div>
    <div class="row" style="justify-content:flex-end;margin-top:12px;"><button id="cancelCustom" class="btn ghost">Annuler</button><button id="acceptCustom" class="btn">Accepter</button></div>
  </div></div>

  <div id="modalExp" class="modal" aria-hidden="true"><div class="backdrop"></div><div class="dialog">
    <button class="close" id="closeExp" title="Fermer"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#7F7F7F" stroke-width="2" stroke-linecap="round"/></svg></button>
    <h3 style="margin:0 0 8px 0">Ajouter une d√©pense</h3>
    <div class="field"><label for="expAmount">Montant (‚Ç¨)</label><input id="expAmount" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="Ex. 12.50"></div>
    <div class="field"><label for="expType">Type d‚Äôachat</label><input id="expType" type="text" placeholder="Ex. Courses, resto, v√™tements‚Ä¶"></div>
    <div class="field"><label for="expWhere">O√π ?</label><input id="expWhere" type="text" placeholder="Ex. Carrefour, Zara‚Ä¶"></div>
    <div class="field"><label for="expPaid">Pay√© avec</label>
      <select id="expPaid"><option value="commun">Compte commun</option><option value="marine">Compte Marine</option><option value="alexis">Compte Alexis</option></select>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px;"><button id="cancelExp" class="btn ghost">Annuler</button><button id="saveExp" class="btn">Valider</button></div>
  </div></div>

  <!-- Modal: Remainder payer for communal overdraft -->
  <div id="modalRemainder" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="dialog">
      <button class="close" id="closeRemainder" title="Fermer">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6l12 12" stroke="#7F9172" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <h3 style="margin:0 0 8px 0">Reste √† payer</h3>
      <p class="muted" id="remainderText" style="margin:0 0 12px 0">Il manque ‚Äî pour couvrir cette d√©pense.</p>
      <div class="field">
        <label>Qui paie le reste ?</label>
        <div class="row">
          <label style="display:flex;align-items:center;gap:8px;"><input type="radio" name="whoPays" value="marine"> Marine</label>
          <label style="display:flex;align-items:center;gap:8px;"><input type="radio" name="whoPays" value="alexis"> Alexis</label>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px;">
        <button id="cancelRemainder" class="btn ghost">Annuler</button>
        <button id="confirmRemainder" class="btn">Confirmer</button>
      </div>
    </div>
  </div>

  <!-- Danger Reset Modal -->
  <div id="modalNuke" class="modal" aria-hidden="true"><div class="backdrop"></div><div class="dialog">
    <button class="close" id="closeNuke" title="Fermer"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#7F7F7F" stroke-width="2" stroke-linecap="round"/></svg></button>
    <h3 style="margin:0 0 8px 0">Supprimer les d√©penses & r√©initialiser les comptes</h3>
    <p class="muted">Cette action va :<br>‚Ä¢ Supprimer <b>toutes</b> les d√©penses<br>‚Ä¢ Remettre la <b>cagnotte</b> √† 0<br>‚Ä¢ R√©initialiser les <b>totaux Marine/Alexis</b></p>
    <div class="field"><label for="nukePwd">Mot de passe</label><input id="nukePwd" type="password" placeholder="Mot de passe" autocomplete="off"></div>
    <p class="muted">Confirmer ?</p>
    <div class="row" style="justify-content:flex-end;margin-top:12px;"><button id="cancelNuke" class="btn ghost">Annuler</button><button id="confirmNuke" class="btn warn">Supprimer</button></div>
  </div></div>

  <div id="modalCompose" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="dialog">
      <button class="close" id="closeCompose" title="Fermer">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6l12 12" stroke="#7F7F7F" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <h3 style="margin:0 0 8px 0">√âcrire ma note du jour</h3>
      <p class="muted" id="composeInfo" style="margin:0 0 12px 0">Elle sera livr√©e √† l‚Äôautre dans 7 jours.</p>
      <div class="field">
        <label for="composeText">Message (max 200 caract√®res)</label>
        <textarea id="composeText" maxlength="200" style="min-height:120px;resize:vertical;background:#fff;"></textarea>
        <div class="muted" id="composeCount">0 / 200</div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px;">
        <button id="cancelCompose" class="btn ghost">Annuler</button>
        <button id="saveCompose" class="btn">Envoyer (J+7)</button>
      </div>
    </div>
  </div>

  <div id="modalViewMsg" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="dialog">
      <button class="close" id="closeViewMsg" title="Fermer">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6l12 12" stroke="#7F7F7F" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <div class="row" style="justify-content:space-between;align-items:center;">
        <h3 id="viewMsgDate" style="margin:0 0 8px 0">‚Äî</h3>
        <button id="btnTogglePin" class="iconbtn" title="√âpingler/D√©s√©pingler">
          <svg id="pinIcon" width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M6 8l6 6M12 8l-6 6M12 2l4 4-8 8-4-4 8-8z" stroke="#7F9172" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <p id="viewMsgContent" style="white-space:pre-wrap"></p>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, increment, deleteDoc, runTransaction,
      collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCpKpzZeZqV41kbTNxg30CCp4ucjRgdpzA",
      authDomain: "marine-project-9ef95.firebaseapp.com",
      projectId: "marine-project-9ef95",
      storageBucket: "marine-project-9ef95.firebasestorage.app",
      messagingSenderId: "390499388891",
      appId: "1:390499388891:web:50983a2ef16f0a51b7ebfe"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
    const cap = s=> s.charAt(0).toUpperCase()+s.slice(1);
    const fmtEUR = v=> new Intl.NumberFormat('fr-BE',{style:'currency',currency:'EUR'}).format(Number(v)||0);
    const monthKey = d=> d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
    const monthLabel = d=> new Intl.DateTimeFormat('fr-BE',{month:'long',year:'numeric'}).format(d);
    const startOfDay = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());

    // Elements
    const screenWelcome=$("#screen-welcome"), screenMain=$("#screen-main"), titleUser=$("#titleUser"), subtitle=$("#subtitle"), helloName=$("#helloName");
    const btnMenu=$("#btnMenu"), btnBack=$("#btnBack"), drawer=$("#drawer"), drawerBackdrop=$("#drawerBackdrop");
    const linkNuke=$("#linkNuke"), modalNuke=$("#modalNuke"), closeNuke=$("#closeNuke"), cancelNuke=$("#cancelNuke"), confirmNuke=$("#confirmNuke"), nukePwd=$("#nukePwd");

    const sectionHome=$("#home"), sectionCadeau=$("#cadeau"), sectionCagnotte=$("#cagnotte"), sectionDepenses=$("#depenses"), sectionAnniv=$("#anniv"), sectionNotes=$("#notes");
    const sectionMots=$("#mots"), sectionPins=$("#epingles");

    // Cadeau
    const btnAddGift=$("#btnAddGift"), btnDeleteGift=$("#btnDeleteGift"), btnViewOther=$("#btnViewOther"), whoseListLabel=$("#whoseListLabel"), otherNameEl=$("#otherName"), otherListWrap=$("#otherListWrap"), otherListEl=$("#otherList"), otherSort=$("#otherSort");
    const modalGift=$("#modalGift"), closeGift=$("#closeGift"), cancelGift=$("#cancelGift"), saveGift=$("#saveGift"), inputGiftName=$("#giftName"), inputGiftPrice=$("#giftPrice"), inputGiftUrl=$("#giftUrl");
    const modalDelGift=$("#modalDelGift"), closeDelGift=$("#closeDelGift"), cancelDelGift=$("#cancelDelGift"), confirmDelGift=$("#confirmDelGift"), delGiftList=$("#delGiftList");

    // Cagnotte
    const potAmount=$("#potAmount"), btnCustomAdd=$("#btnCustomAdd"), modalCustom=$("#modalCustom"), closeCustom=$("#closeCustom"), cancelCustom=$("#cancelCustom"), acceptCustom=$("#acceptCustom"), inputCustom=$("#customAmount");

    // D√©penses
    const monthsWrap=$("#monthsWrap"), btnAddExp=$("#btnAddExp"), modalExp=$("#modalExp"), closeExp=$("#closeExp"), cancelExp=$("#cancelExp"), saveExp=$("#saveExp");
    const inputExpAmount=$("#expAmount"), inputExpType=$("#expType"), inputExpWhere=$("#expWhere"), inputExpPaid=$("#expPaid");
    const totalMarine=$("#totalMarine"), totalAlexis=$("#totalAlexis");
    const totalsRef = doc(db,"stats","totauxDepenses");

    // Remainder modal
    const modalRemainder=$("#modalRemainder"), closeRemainder=$("#closeRemainder"), cancelRemainder=$("#cancelRemainder"), confirmRemainder=$("#confirmRemainder"), remainderText=$("#remainderText");

    // Anniv
    const coupleYears=$("#coupleYears"), coupleDays=$("#coupleDays"), alexisDays=$("#alexisDays"), marineDays=$("#marineDays");

    // Notes
    const noteBox=$("#noteBox"), noteStatus=$("#noteStatus");

    // Mot du jour & √©pingl√©s
    const btnOpenInbox=$("#btnOpenInbox"), btnCompose=$("#btnCompose"), inboxWrap=$("#inboxWrap"), inboxOwner=$("#inboxOwner"), inboxList=$("#inboxList");
    const pinsList=$("#pinsList");
    const modalCompose=$("#modalCompose"), closeCompose=$("#closeCompose"), cancelCompose=$("#cancelCompose"), saveCompose=$("#saveCompose"), composeText=$("#composeText"), composeCount=$("#composeCount");
    const modalViewMsg=$("#modalViewMsg"), closeViewMsg=$("#closeViewMsg"), btnTogglePin=$("#btnTogglePin"), pinIcon=$("#pinIcon"), viewMsgDate=$("#viewMsgDate"), viewMsgContent=$("#viewMsgContent");

    // Helpers
    function showToast(m,ms=2200){ const el=$("#toast"); el.textContent=m; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),ms); }
    function openDrawer(open=true){ drawer.classList.toggle("open", open); }
    function openModal(m,open=true){ if(!m) return; m.classList.toggle("open", open); m.setAttribute("aria-hidden", open?"false":"true"); }

    let currentUserId=null, displayName=null, view="welcome";
    let unsubOther=null, unsubPot=null, unsubExp=null, unsubTotals=null, unsubInbox=null, unsubPins=null;
    let annivTimerId=null, notesSaveTimer=null, pendingExpense=null;
    let cachedOtherItems=[];

    // Navigation
    function setView(name){
      view=name;
      if(name==="welcome"){ screenWelcome.classList.remove("hidden"); screenMain.classList.add("hidden"); }
      else{
        screenWelcome.classList.add("hidden"); screenMain.classList.remove("hidden");
        sectionHome.classList.toggle("hidden", name!=="home");
        sectionCadeau.classList.toggle("hidden", name!=="cadeau");
        sectionCagnotte.classList.toggle("hidden", name!=="cagnotte");
        sectionDepenses.classList.toggle("hidden", name!=="depenses");
        sectionAnniv.classList.toggle("hidden", name!=="anniversaires");
        sectionNotes.classList.toggle("hidden", name!=="notes");
        sectionMots.classList.toggle("hidden", name!=="mots");
        sectionPins.classList.toggle("hidden", name!=="epingles");
        subtitle.textContent = name==="home"?"Menu principal": name==="cadeau"?"Cadeaux": name==="cagnotte"?"Compte commun": name==="depenses"?"D√©penses": name==="anniversaires"?"Anniversaires": name==="mots"?"Mot du jour": name==="epingles"?"√âpingl√©s":"Notes";
      }
    }
    btnBack.addEventListener("click", ()=>{ if(view==="home") setView("welcome"); else setView("home"); });
    btnMenu.addEventListener("click", ()=> openDrawer(true));
    drawerBackdrop.addEventListener("click", ()=> openDrawer(false));
    $$(".navitem").forEach(b=> b.addEventListener("click", ()=>{ const nav=b.dataset.nav; openDrawer(false);
      if(nav==="cadeau") openCadeau(); else if(nav==="cagnotte") openCagnotte(); else if(nav==="depenses") openDepenses(); else if(nav==="anniversaires") openAnniversaires(); else if(nav==="notes") openNotes(); else if(nav==="mots") openMots(); else if(nav==="epingles") openPins();
    }));

    // Reset
    function showNuke(){ openModal(modalNuke,true); }
    window.showNuke = showNuke;
    linkNuke.addEventListener("click", (e)=>{ e.preventDefault(); showNuke(); });
    cancelNuke.addEventListener("click", ()=> openModal(modalNuke,false));
    closeNuke.addEventListener("click", ()=> openModal(modalNuke,false));
    modalNuke.querySelector(".backdrop").addEventListener("click", ()=> openModal(modalNuke,false));
    confirmNuke.addEventListener("click", async ()=>{
      const pwd=(nukePwd.value||"").trim(); if(pwd!=="St@dium17893Us"){ showToast("Mot de passe incorrect"); return; }
      try{
        const snap=await getDocs(collection(db,"depenses")); const deletions=[]; snap.forEach(d=> deletions.push(deleteDoc(doc(db,"depenses", d.id)))); await Promise.all(deletions);
        await setDoc(doc(db,"cagnotte","shared"), { amount:0, currency:"EUR", updatedAt:new Date().toISOString() }, { merge:true });
        await setDoc(totalsRef, { marine:0, alexis:0, updatedAt:new Date().toISOString() }, { merge:true });
        showToast("D√©penses & comptes r√©initialis√©s"); openModal(modalNuke,false);
      }catch(e){ console.error(e); showToast("Erreur: "+(e.message||e)); }
    });

    // Bootstrap Firestore
    async function ensureBaseDocs(userId){
      const uref=doc(db,"users",userId); const usnap=await getDoc(uref); if(!usnap.exists()) await setDoc(uref,{name:cap(userId),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}); else await updateDoc(uref,{updatedAt:new Date().toISOString()});
      const lref=doc(db,"listes",userId); const lsnap=await getDoc(lref); if(!lsnap.exists()) await setDoc(lref,{owner:userId,createdAt:new Date().toISOString()});
      const cref=doc(db,"cagnotte","shared"); const csnap=await getDoc(cref); if(!csnap.exists()) await setDoc(cref,{amount:0,currency:"EUR",updatedAt:new Date().toISOString()});
      const nref=doc(db,"notes",userId); const nsnap=await getDoc(nref); if(!nsnap.exists()) await setDoc(nref,{content:"",updatedAt:new Date().toISOString()});
      const tsnap=await getDoc(totalsRef); if(!tsnap.exists()) await setDoc(totalsRef,{marine:0,alexis:0,updatedAt:new Date().toISOString()});
    }

    // Login
    async function connectAs(name){
      const id=(name||'').toLowerCase();
      try{
        await ensureBaseDocs(id); localStorage.setItem("currentUser", id); currentUserId=id; displayName=cap(id);
        titleUser.textContent="Bonjour "+displayName+" üëã"; helloName.textContent=displayName; whoseListLabel.textContent="Ta liste : "+displayName;
        setView("home"); showToast("Connect√© en tant que "+displayName); loadNotes();
      }catch(e){ console.error(e); showToast("Erreur de connexion : "+(e.message||e)); }
    }
    window.connectAs = connectAs;
    // Primary welcome listeners
    $$("#screen-welcome .btn[data-user]").forEach(b=> b.addEventListener("click", (ev)=>{ ev.preventDefault(); connectAs(b.dataset.user); }));
    // Delegated fallback
    document.addEventListener("click",(ev)=>{
      const el = ev.target.closest && ev.target.closest("#screen-welcome .btn[data-user]");
      if(el){ ev.preventDefault(); connectAs(el.dataset.user); }
      if(ev.target.closest && ev.target.closest("#linkNuke")){ ev.preventDefault(); showNuke(); }
    });
    // Auto-login
    const saved=localStorage.getItem("currentUser"); if(saved){ connectAs(saved); } else { setView("welcome"); }

    // Cadeau
    function openCadeau(){
      const other=currentUserId==="alexis"?"Marine":"Alexis"; btnViewOther.textContent="Voir la liste de "+other; otherNameEl.textContent=other; otherListWrap.classList.add("hidden"); if(unsubOther){unsubOther();unsubOther=null;} setView("cadeau");
    }
    closeGift.addEventListener("click", ()=> openModal(modalGift,false));
    cancelGift.addEventListener("click", ()=> openModal(modalGift,false));
    modalGift.querySelector(".backdrop").addEventListener("click", ()=> openModal(modalGift,false));
    btnAddGift.addEventListener("click", ()=>{ inputGiftName.value=""; inputGiftPrice.value=""; inputGiftUrl.value=""; openModal(modalGift,true); });
    async function addGiftToMyList(){
      const title=inputGiftName.value.trim(); const raw=inputGiftPrice.value.trim().replace(",","."); const url=inputGiftUrl.value.trim();
      if(!title){ showToast("Indique un nom d‚Äôarticle"); return; } if(!raw||isNaN(Number(raw))){ showToast("Le prix doit √™tre un nombre"); return; }
      try{ await addDoc(collection(db,"listes",currentUserId,"items"),{title,price:Number(raw),url:url||null,createdAt:serverTimestamp()}); showToast("Ajout√© √† ta liste"); openModal(modalGift,false); }
      catch(e){ console.error(e); showToast("Erreur: "+(e.message||e)); }
    }
    saveGift.addEventListener("click", addGiftToMyList);
    btnViewOther.addEventListener("click", ()=>{ otherListWrap.classList.remove("hidden"); subscribeOtherList(); });
    function subscribeOtherList(){
      const otherId=currentUserId==="alexis"?"marine":"alexis"; const ql=query(collection(db,"listes",otherId,"items"),orderBy("createdAt","desc"));
      if(unsubOther){unsubOther();unsubOther=null;}
      unsubOther=onSnapshot(ql,snap=>{
        cachedOtherItems = [];
        snap.forEach(d=>{
          const it=d.data();
          cachedOtherItems.push({ id:d.id, title:it.title||"(Sans nom)", price:Number(it.price||0), url:it.url||null, createdAt: it.createdAt?.toDate?.()? it.createdAt.toDate() : (it.createdAt? new Date(it.createdAt): new Date()) });
        });
        renderOtherList();
      },err=>{ console.error(err); showToast("Lecture de la liste impossible"); });
    }
    function renderOtherList(){
      const mode = otherSort.value;
      const arr = [...cachedOtherItems];
      if(mode==="price_asc"){ arr.sort((a,b)=> a.price-b.price); }
      else if(mode==="price_desc"){ arr.sort((a,b)=> b.price-a.price); }
      else { // date_desc
        arr.sort((a,b)=> b.createdAt - a.createdAt);
      }
      otherListEl.innerHTML = arr.length? "" : '<p class="muted">Aucun √©l√©ment pour le moment.</p>';
      arr.forEach(it=>{
        const row=document.createElement("div"); row.className="giftRow";
        const a=document.createElement("a"); a.textContent=it.title; a.href=it.url||"#"; if(it.url){ a.target="_blank"; a.rel="noopener"; }
        const p=document.createElement("div"); p.className="price"; p.textContent=fmtEUR(it.price);
        row.append(a,p); otherListEl.appendChild(row);
      });
    }
    otherSort.addEventListener("change", renderOtherList);
    // Delete gifts
    closeDelGift.addEventListener("click", ()=> openModal(modalDelGift,false));
    cancelDelGift.addEventListener("click", ()=> openModal(modalDelGift,false));
    modalDelGift.querySelector(".backdrop").addEventListener("click", ()=> openModal(modalDelGift,false));
    btnDeleteGift.addEventListener("click", async ()=>{ await loadMyGiftListForDelete(); openModal(modalDelGift,true); });
    async function loadMyGiftListForDelete(){
      delGiftList.innerHTML="<div class='muted' style='padding:6px 4px;'>Chargement‚Ä¶</div>";
      const snap=await getDocs(query(collection(db,"listes",currentUserId,"items"),orderBy("createdAt","desc")));
      if(snap.empty){ delGiftList.innerHTML="<div class='muted' style='padding:6px 4px;'>Ta liste est vide.</div>"; return; }
      const wrap=document.createElement("div");
      snap.forEach(docSnap=>{ const d=docSnap.data(); const row=document.createElement("label"); row.style.display="flex"; row.style.alignItems="center"; row.style.gap="10px"; row.style.padding="8px"; row.style.borderBottom="1px solid #f0f2f4";
        const cb=document.createElement("input"); cb.type="checkbox"; cb.value=docSnap.id; const name=document.createElement("div"); name.textContent=d.title||"(Sans nom)"; row.append(cb,name); wrap.appendChild(row); });
      delGiftList.innerHTML=""; delGiftList.appendChild(wrap);
    }
    async function confirmDeleteGifts(){
      const cbs=delGiftList.querySelectorAll("input[type='checkbox']:checked"); if(cbs.length===0){ showToast("S√©lectionne au moins un objet"); return; }
      try{ await Promise.all(Array.from(cbs).map(cb=> deleteDoc(doc(db,"listes",currentUserId,"items",cb.value)))); showToast("Objet(s) supprim√©(s)"); openModal(modalDelGift,false); }
      catch(e){ console.error(e); showToast("Erreur: "+(e.message||e)); }
    }
    confirmDelGift.addEventListener("click", confirmDeleteGifts);

    // Cagnotte
    function openCagnotte(){
      if(unsubPot){ unsubPot(); unsubPot=null; }
      const ref=doc(db,"cagnotte","shared");
      unsubPot=onSnapshot(ref,snap=>{ const d=snap.data(); potAmount.textContent=d?fmtEUR(d.amount||0):"‚Äî"; });
      setView("cagnotte");
    }
    function addAmount(val){
      const n=Number(val); if(!Number.isFinite(n)||n<=0){ showToast("Montant invalide"); return; }
      const ref=doc(db,"cagnotte","shared");
      updateDoc(ref,{amount:increment(n),updatedAt:new Date().toISOString()})
        .catch(async (e)=>{ if(e && /NOT_FOUND|no document/i.test(String(e))){ await setDoc(ref,{amount:0,currency:"EUR",updatedAt:new Date().toISOString()},{merge:true}); return updateDoc(ref,{amount:increment(n),updatedAt:new Date().toISOString()}); } throw e; })
        .then(()=> showToast("+"+fmtEUR(n)+" ajout√©(e)"))
        .catch(err=>{ console.error(err); showToast("Erreur: "+(err.message||err)); });
    }
    $$(".cardBtn[data-add]").forEach(b=> b.addEventListener("click", ()=> addAmount(b.dataset.add)));
    btnCustomAdd.addEventListener("click", ()=>{ inputCustom.value=""; openModal(modalCustom,true); });
    acceptCustom.addEventListener("click", ()=>{ const raw=(inputCustom.value||"" ).trim(); if(!/^[0-9]+$/.test(raw)){ showToast("Indique uniquement des chiffres"); return; } addAmount(Number(raw)); openModal(modalCustom,false); });
    cancelCustom.addEventListener("click", ()=> openModal(modalCustom,false));
    closeCustom.addEventListener("click", ()=> openModal(modalCustom,false));
    modalCustom.querySelector(".backdrop").addEventListener("click", ()=> openModal(modalCustom,false));

    // D√©penses + Totaux
    function openDepenses(){ subscribeTotals(); subscribeExpenses(); setView("depenses"); }
    function subscribeTotals(){ if(unsubTotals){unsubTotals();unsubTotals=null;} unsubTotals=onSnapshot(totalsRef,snap=>{ const d=snap.data()||{marine:0,alexis:0}; totalMarine.textContent=fmtEUR(d.marine||0); totalAlexis.textContent=fmtEUR(d.alexis||0); }); }
    function subscribeExpenses(){
      if(unsubExp){ unsubExp(); unsubExp=null; }
      const qexp=query(collection(db,"depenses"),orderBy("createdAt","desc"));
      unsubExp=onSnapshot(qexp,snap=>{
        const groups=new Map();
        snap.forEach(ds=>{ const d=ds.data(); const dt=d.createdAt?.toDate?.()? d.createdAt.toDate(): new Date(); const mk=monthKey(dt); if(!groups.has(mk)) groups.set(mk,[]); groups.get(mk).push({id:ds.id,...d,_date:dt}); });
        renderMonths(groups);
      },err=>{ console.error(err); showToast("Lecture des d√©penses impossible"); });
    }
    function renderMonths(groups){
      const entries=Array.from(groups.entries()).sort((a,b)=> b[0].localeCompare(a[0])); monthsWrap.innerHTML="";
      if(entries.length===0){ monthsWrap.innerHTML='<p class="muted">Aucune d√©pense pour le moment.</p>'; return; }
      entries.forEach(([mk,rows])=>{
        const sample=rows[0]._date; const headLabel=monthLabel(new Date(sample.getFullYear(),sample.getMonth(),1));
        const total=rows.reduce((s,r)=> s+(Number(r.amount)||0),0);
        const monthEl=document.createElement("div"); monthEl.className="month";
        const head=document.createElement("div"); head.className="monthHead";
        const title=document.createElement("div"); title.textContent=headLabel;
        const totalEl=document.createElement("div"); totalEl.className="total"; totalEl.textContent=fmtEUR(total);
        head.append(title,totalEl);
        const body=document.createElement("div"); body.className="monthBody";
        rows.forEach(r=>{ const row=document.createElement("div"); row.className="expRow";
          const badge=document.createElement("div"); badge.className="badge"; badge.textContent=(r.paidWith==="commun"?(r.remainderPaidBy?("Commun + "+(r.remainderPaidBy==="marine"?"Marine":"Alexis")):"Commun"):(r.paidWith==="marine"?"Marine":"Alexis"));
          const where=document.createElement("div"); where.textContent=(r.where||r.type||"‚Äî");
          const amt=document.createElement("div"); amt.style.fontWeight="800"; amt.textContent=fmtEUR(r.amount||0);
          row.append(badge,where,amt); body.appendChild(row);
        });
        head.addEventListener("click", ()=> monthEl.classList.toggle("open"));
        monthEl.append(head,body); monthsWrap.appendChild(monthEl);
      });
    }
    // Expense modal
    btnAddExp.addEventListener("click", ()=>{ inputExpAmount.value=""; inputExpType.value=""; inputExpWhere.value=""; inputExpPaid.value="commun"; openModal(modalExp,true); });
    cancelExp.addEventListener("click", ()=> openModal(modalExp,false));
    closeExp.addEventListener("click", ()=> openModal(modalExp,false));
    modalExp.querySelector(".backdrop").addEventListener("click", ()=> openModal(modalExp,false));
    // Save expense with overdraft handling
    async function saveExpense(){
      const raw=(inputExpAmount.value||"").trim().replace(",","."); if(!raw||isNaN(Number(raw))){ showToast("Le montant doit √™tre un nombre"); return; }
      const amount=Number(raw); const paid=inputExpPaid.value;
      const data={ amount, type:(inputExpType.value||"").trim(), where:(inputExpWhere.value||"").trim(), paidWith: paid, createdAt: serverTimestamp() };
      try{
        if(paid==="commun"){
          const cref=doc(db,"cagnotte","shared");
          const csnap=await getDoc(cref);
          const curr = (csnap.exists() && typeof csnap.data().amount === "number") ? csnap.data().amount : 0;
          if(amount <= curr){
            await addDoc(collection(db,"depenses"), data);
            await runTransaction(db, async (tx)=>{
              const s=await tx.get(cref); const c=(s.exists()&&typeof s.data().amount==='number')?s.data().amount:0;
              tx.set(cref,{amount: Math.max(0, c-amount), currency: "EUR", updatedAt: new Date().toISOString()},{merge:true});
            });
            showToast("D√©pense ajout√©e"); openModal(modalExp,false);
          }else{
            pendingExpense = { data };
            remainderText.textContent = "Il manque " + fmtEUR(amount - curr) + " pour couvrir cette d√©pense.";
            openModal(modalExp,false); openModal(modalRemainder,true);
          }
        }else{
          await addDoc(collection(db,"depenses"), data);
          if(paid==="marine"||paid==="alexis"){
            try{ await updateDoc(totalsRef,{ [paid]: increment(amount), updatedAt:new Date().toISOString() }); }
            catch(e){ await setDoc(totalsRef,{ marine:0, alexis:0, updatedAt:new Date().toISOString() },{merge:true}); await updateDoc(totalsRef,{ [paid]: increment(amount), updatedAt:new Date().toISOString() }); }
          }
          showToast("D√©pense ajout√©e"); openModal(modalExp,false);
        }
      }catch(e){ console.error(e); showToast("Erreur: "+(e.message||e)); }
    }
    saveExp.addEventListener("click", saveExpense);

    // Remainder modal handlers
    function getRemainderChoice(){ const el=document.querySelector("input[name='whoPays']:checked"); return el?el.value:null; }
    async function confirmRemainderFn(){
      if(!pendingExpense){ openModal(modalRemainder,false); return; }
      const who = getRemainderChoice(); if(!who){ showToast("Choisis qui paie le reste"); return; }
      const { data } = pendingExpense; pendingExpense=null;
      try{
        const cref=doc(db,"cagnotte","shared");
        let remainderToCharge=0;
        await runTransaction(db, async (tx)=>{
          const s=await tx.get(cref); const curr=(s.exists() && typeof s.data().amount==="number")?s.data().amount:0;
          const toDeduct=Math.min(curr, data.amount);
          remainderToCharge=Math.max(0, data.amount - toDeduct);
          tx.set(cref,{amount:curr - toDeduct, currency:"EUR", updatedAt:new Date().toISOString()},{merge:true});
        });
        if(remainderToCharge>0){
          try{ await updateDoc(totalsRef,{ [who]: increment(remainderToCharge), updatedAt:new Date().toISOString() }); }
          catch(e){ await setDoc(totalsRef,{ marine:0, alexis:0, updatedAt:new Date().toISOString() },{merge:true}); await updateDoc(totalsRef,{ [who]: increment(remainderToCharge), updatedAt:new Date().toISOString() }); }
        }
        await addDoc(collection(db,"depenses"), { ...data, remainder: remainderToCharge, remainderPaidBy: who });
        showToast("D√©pense ajout√©e (reste pay√© par "+(who==="marine"?"Marine":"Alexis")+")");
        openModal(modalRemainder,false);
      }catch(e){ console.error(e); showToast("Erreur: "+(e.message||e)); }
    }
    confirmRemainder.addEventListener("click", confirmRemainderFn);
    cancelRemainder.addEventListener("click", ()=>{ pendingExpense=null; openModal(modalRemainder,false); });
    closeRemainder.addEventListener("click", ()=>{ pendingExpense=null; openModal(modalRemainder,false); });
    modalRemainder.querySelector(".backdrop").addEventListener("click", ()=>{ pendingExpense=null; openModal(modalRemainder,false); });

    // Anniversaires counters
    function openAnniversaires(){ startCounters(); setView("anniversaires"); }
    function nextCoupleTarget(now){
      const baseYear=2024, m=4, d=17; // 17/05
      const y=now.getFullYear(); let target=new Date(y,m,d);
      const sod=(t)=> new Date(t.getFullYear(),t.getMonth(),t.getDate());
      if(sod(target) < sod(now)) target=new Date(y+1,m,d);
      const n = target.getFullYear() - baseYear; return {n,target};
    }
    function nextYearly(day, monthIndex, now){ const y=now.getFullYear(); let t=new Date(y,monthIndex,day); if(new Date(y,monthIndex,day) < new Date(y, now.getMonth(), now.getDate())) t=new Date(y+1,monthIndex,day); return t; }
    function daysLeft(to, now){ const ms=86400000; const sod=(t)=> new Date(t.getFullYear(),t.getMonth(),t.getDate()); return Math.max(0, Math.ceil((sod(to)-sod(now))/ms)); }
    function startCounters(){
      if(annivTimerId) clearInterval(annivTimerId);
      function tick(){
        const now=new Date();
        const {n,target}=nextCoupleTarget(now); coupleYears.textContent = n + (n>1?" ans":" an"); coupleDays.textContent = daysLeft(target,now)+" jours";
        const alex=nextYearly(22,1,now); alexisDays.textContent = daysLeft(alex,now)+" jours";
        const mar=nextYearly(31,4,now); marineDays.textContent = daysLeft(mar,now)+" jours";
      }
      tick(); annivTimerId=setInterval(tick, 60000);
    }

    // Notes
    function openNotes(){ loadNotes(); setView("notes"); }
    async function loadNotes(){ const ref=doc(db,"notes",currentUserId); const snap=await getDoc(ref); const d=snap.data(); noteBox.value=d?.content||""; noteStatus.textContent=d?("Modifi√© le "+new Date(d.updatedAt||Date.now()).toLocaleString("fr-BE")):"‚Äî"; }
    noteBox.addEventListener("input", ()=>{
      if(notesSaveTimer) clearTimeout(notesSaveTimer);
      notesSaveTimer = setTimeout(async ()=>{
        const ref=doc(db,"notes",currentUserId);
        await setDoc(ref,{content:noteBox.value,updatedAt:new Date().toISOString()},{merge:true});
        noteStatus.textContent="Enregistr√© √† "+new Date().toLocaleTimeString("fr-BE");
      }, 500);
    });

    // Mot du jour / √âpingl√©s
    function openMots(){
      const other = currentUserId === "alexis" ? "Marine" : "Alexis";
      btnOpenInbox.textContent = "Ouvrir les mots de " + other;
      inboxOwner.textContent = currentUserId === "alexis" ? "Alexis" : "Marine";
      inboxWrap.classList.add("hidden");
      if(unsubInbox){unsubInbox();unsubInbox=null;}
      setView("mots");
    }
    function openPins(){
      if(unsubPins){unsubPins();unsubPins=null;}
      const ref = collection(db, "mots", currentUserId, "items");
      unsubPins = onSnapshot(ref, (snap)=>{
        const items = [];
        snap.forEach(d=>{ const v=d.data(); if(v.pinned===true){ items.push({id:d.id, ...v}); } });
        items.sort((a,b)=> new Date(b.deliverAt||b.createdAt||0) - new Date(a.deliverAt||a.createdAt||0));
        renderPins(items);
      });
      setView("epingles");
    }
    function renderPins(items){
      pinsList.innerHTML = items.length? "" : '<p class="muted">Aucun message √©pingl√©.</p>';
      items.forEach(it=>{
        const row=document.createElement("div"); row.className="giftRow";
        const dateStr = formatFrenchDate(new Date(it.dateWritten||it.createdAt||Date.now()));
        const a=document.createElement("a"); a.textContent = dateStr; a.href="#";
        a.addEventListener("click",(e)=>{ e.preventDefault(); openViewMessage(it.id, it); });
        const p=document.createElement("div"); p.className="price"; p.textContent = (it.content||"").slice(0,20) + ((it.content||"").length>20?"‚Ä¶":"");
        row.append(a,p); pinsList.appendChild(row);
      });
    }
    // Inbox open
    btnOpenInbox.addEventListener("click", ()=>{
      const otherId = currentUserId === "alexis" ? "marine" : "alexis";
      inboxWrap.classList.remove("hidden");
      const ref = collection(db, "mots", currentUserId, "items");
      if(unsubInbox){unsubInbox();unsubInbox=null;}
      unsubInbox = onSnapshot(ref, (snap)=>{
        const now = Date.now();
        const items = [];
        snap.forEach(d=>{
          const v = d.data();
          const deliverAt = v.deliverAt ? new Date(v.deliverAt).getTime() : 0;
          if(v.author === otherId && deliverAt <= now){ items.push({id:d.id, ...v}); }
        });
        items.sort((a,b)=> new Date(b.deliverAt||b.createdAt||0) - new Date(a.deliverAt||a.createdAt||0));
        renderInbox(items);
      }, (err)=>{ console.error(err); showToast("Lecture des mots impossible"); });
    });
    function renderInbox(items){
      inboxList.innerHTML = items.length? "" : '<p class="muted">Aucun mot pour le moment.</p>';
      items.forEach(it=>{
        const row=document.createElement("div"); row.className="giftRow";
        const dateStr = formatFrenchDate(new Date(it.dateWritten||it.createdAt||Date.now()));
        const a=document.createElement("a"); a.textContent = dateStr; a.href="#";
        a.addEventListener("click",(e)=>{ e.preventDefault(); openViewMessage(it.id, it); });
        const p=document.createElement("div"); p.className="price"; p.textContent = (it.content||"").slice(0,20) + ((it.content||"").length>20?"‚Ä¶":"");
        row.append(a,p); inboxList.appendChild(row);
      });
    }
    // Compose
    btnCompose.addEventListener("click", ()=>{
      composeText.value=""; composeCount.textContent="0 / 200";
      const toName = currentUserId === "alexis" ? "Marine" : "Alexis";
      $("#composeInfo").textContent = "Ce message sera livr√© √† " + toName + " dans 7 jours.";
      openModal(modalCompose, true);
    });
    composeText.addEventListener("input", ()=>{
      const len = (composeText.value||"").length;
      composeCount.textContent = len + " / 200";
    });
    cancelCompose.addEventListener("click", ()=> openModal(modalCompose, false));
    closeCompose.addEventListener("click", ()=> openModal(modalCompose, false));
    modalCompose.querySelector(".backdrop").addEventListener("click", ()=> openModal(modalCompose, false));
    saveCompose.addEventListener("click", async ()=>{
      const txt = (composeText.value||"").trim();
      if(!txt){ showToast("√âcris un petit mot üíå"); return; }
      if(txt.length>200){ showToast("200 caract√®res max"); return; }
      try{
        const now = new Date();
        const deliver = new Date(now.getTime() + 7*24*60*60*1000);
        const recipient = currentUserId === "alexis" ? "marine" : "alexis";
        await addDoc(collection(db, "mots", recipient, "items"), {
          author: currentUserId,
          content: txt,
          dateWritten: now.toISOString(),
          deliverAt: deliver.toISOString(),
          createdAt: serverTimestamp(),
          pinned: false
        });
        openModal(modalCompose, false);
        showToast("Ton mot a √©t√© programm√© pour J+7 ‚ú®");
      }catch(e){ console.error(e); showToast("Erreur: "+(e.message||e)); }
    });
    // View message + pin toggle
    let currentMsgId=null;
    function openViewMessage(id, data){
      currentMsgId = id;
      const d = data || {};
      viewMsgDate.textContent = formatFrenchDate(new Date(d.dateWritten||d.createdAt||Date.now()));
      viewMsgContent.textContent = (d.content||"");
      setPinIcon(d.pinned===true);
      openModal(modalViewMsg, true);
    }
    function setPinIcon(pinned){ pinIcon.style.opacity = pinned ? "1" : ".35"; }
    btnTogglePin.addEventListener("click", async ()=>{
      if(!currentMsgId) return;
      try{
        const ref = doc(db, "mots", currentUserId, "items", currentMsgId);
        const snap = await getDoc(ref);
        const prev = snap.exists()? !!snap.data().pinned : false;
        await setDoc(ref, { pinned: !prev }, { merge: true });
        setPinIcon(!prev);
        showToast(!prev ? "Message √©pingl√© üìå" : "√âpingle retir√©e");
      }catch(e){ console.error(e); showToast("Erreur: "+(e.message||e)); }
    });
    closeViewMsg.addEventListener("click", ()=> openModal(modalViewMsg, false));
    modalViewMsg.querySelector(".backdrop").addEventListener("click", ()=> openModal(modalViewMsg, false));

    // Helper: French long date (e.g., 25 septembre 2025)
    function formatFrenchDate(dt){ return new Intl.DateTimeFormat('fr-FR',{day:'numeric',month:'long',year:'numeric'}).format(dt); }

    // Orientation lock
    try{ if(screen.orientation && screen.orientation.lock){ screen.orientation.lock("portrait").catch(()=>{}); } }catch(_){}
  </script>
</body>
</html>
